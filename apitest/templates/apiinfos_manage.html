{% extends 'base_list.html' %}

{# 导航栏 #}
{% block navbar %}
    <li class="active"><a href="{% url 'apis_manage' %}">api用例</a></li>
    <!-- <li><a href="{% url 'apitest_manage' %}">流程接口</a></li> -->
    <li><a href="{% url 'appcase_manage' %}">app用例</a></li>
    <li><a href="{% url 'webcase_manage' %}">web用例</a></li>
{% endblock %}

{# 搜索和添加功能 #}
{% block search_add %}
    <button type="submit" class="btn btn-default navbar-btn">
        <a href="{% url 'apiinfos_manage' %}?apis.id={{ apis.id }}" style="color: rgb(51, 51, 51);">刷新</a>
    </button>
{% endblock %}

{# 表格头部 #}
{% block thead %}
    <tr>
        <th>模块：{{ apis.apiname }}
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            测试负责人：{{ apis.apitester }}
        </th>
    </tr>
{% endblock %}

{# 表格主体 #}
{% block tbody %}
{% endblock %}

{# 显示数量 #}
{% block count %}
{% endblock %}

{# 翻页 #}
{% block pager %}
{% endblock %} 

{# 额外内容 #}
{% block else %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <a href="#login-info" data-toggle="collapse">测试登陆信息</a>
            </h3>
        </div>
        <div class="panel-body panel-collapse collapse" id="login-info">
            <div class="panel-body">
                <span>{{ response }}</span>
            </div>
        </div>
    </div>
    {% for apisinfo in apiinfos %}
        {% if apisinfo.api.id == apis.id  %}
            <div class="panel-group" id="accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <a href="#{{ apisinfo.id }}" data-toggle="collapse">{{ apisinfo.apiname }}</a>
                        </h3>
                    </div>
                    <div id="{{ apisinfo.id }}" class="panel-collapse collapse">
                        <div class="panel-body">
                            <!-- <form class="bs-example bs-example-form" role="form"> -->
                                <div class="input-group">
                                    <span class="input-group-addon url">&nbsp;&nbsp;&nbsp;&nbsp;URL&nbsp;地&nbsp;址：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.apiurl }}">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon param">请求PARAM：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.apiparamvalue }}">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon json">请求数据JSON：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.apijson }}">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon method">请求方法：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.apimethod }}">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon except">响应数据JSON：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.apiresponse }}">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon result">自动化测试结果：</span>
                                    {% if apisinfo.apistatus == 1 %}
                                        <input type="text" class="form-control" style='color:green' value="{{ apisinfo.apistatus }}">
                                    {% else %}
                                        <input type="text" class="form-control" style='color:red' value="{{ apisinfo.apistatus }}">
                                    {% endif %}                  
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon update-time">执行时间：</span>
                                    <input type="text" class="form-control" value="{{ apisinfo.create_time }}">
                                </div>
                                <div>
                                    <br>
                                    <button class="test">测试</button>
                                </div>
                                <div>
                                    测试结果：<span class="result">unkonwn</span>
                                </div>
                                <div>
                                    实际返回数据：<pre class="response">unkonwn</pre>
                                </div>
                            <!-- </form> -->
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
        {% endif %}
    {% endfor %}
    <div style="width: 100px;margin: 0 auto;">
        <td>
            <a style='color:light blue'  href="/apitest/apis_manage/" >
                <img src="/static/admin/img/icon-yes.svg" alt="返回"/>返回
            </a>
            </td>        
            <td>
            <a style='color:light blue' 
                class="related-widget-wrapper-link add-related" 
                id="add_id_Apitest" 
                href="/admin/apitest/apis/{{ apis.id  }}/change/?_to_field=id&amp;_popup=1">
                <img src="/static/admin/img/icon-changelink.svg"/>编辑
            </a>
        </td>
    </div>
    <!-- 图表容器 DOM -->
    <div class="container">
            <div id="container" class="col-sm-6 col-sm-offset-3" style="height: 300px;"></div>
    </div>
    <!-- 引入 highcharts.js -->
    <script src="http://cdn.hcharts.cn/highcharts/highcharts.js"></script>
    <script>
        // 图表配置
        var options = {
            chart: {
                type: 'column'                          //指定图表的类型，默认是折线图（line）
            },
            title: {
                text: '一周内测试记录'                 // 标题
            },
            xAxis: {
                categories: {{ test_times|safe }}   // x 轴分类
            },
            yAxis: {
                title: {
                    text: null,                // y 轴标题
                },
                labels: {
                    enabled: true
                }
            },
            colors: ['#058DC7', '#00FF00', '#FF0000', '#DDDF00',
				 '#24CBE5', '#64E572', '#FF9655', '#FFF263', '#6AF9C4'],
            series: [{                              // 数据列
                name: 'ALL',                        // 数据列名
                data: {{ test_all }}                 // 数据
            },{
                name: 'PASS',                        // 数据列名
                data: {{ test_pass }}                 // 数据
            },{
                name: 'FAIL',                        // 数据列名
                data: {{ test_fail }}                 // 数据
            }, ],
            plotOptions: {
                column: {
                    dataLabels: {
                        enabled:true,
                    },
                },
            }
        };
        // 图表初始化函数
        var chart = Highcharts.chart('container', options);
    </script>
    <script>
        // json对象转url格式，如{'xxx':'xxx','xxx':'xxx'}转为xxx=xxx&xxx=xxx   
        // data为json对象
        function parseParams(data) {
            try {
                var tempArr = [];
                for (var i in data) {
                    var key = encodeURIComponent(i);
                    var value = encodeURIComponent(data[i]);
                    tempArr.push(key + '=' + value);
                }
                var urlParamsStr = tempArr.join('&');
                return urlParamsStr;
            } catch (err) {
                return '';
            }
        }
        //HTML加载完运行的函数
        $(function(){
            // 格式化API参数，并显示
            // 收到测试API
            $("button.test").click(function(){
                var method,url,json,result,response
                alert("开始")
                $(this).parent().prevAll().each(function(){
                    if ($(this).find('span').attr("class")=="input-group-addon method"){
                        method=$(this).find('input').val()
                    }
                    if ($(this).find('span').attr("class")=="input-group-addon url"){
                        url="https://www.wukoon-app.com"+$(this).find('input').val()
                    }
                    if ($(this).find('span').attr("class")=="input-group-addon json"){
                        json=$(this).find('input').val()
                        if (json!="None"){
                            json=JSON.parse(json)
                            $.each(json,function(key, val){
                                if (val=="NOW"){
                                    json[key]=Date.parse(new Date())/1000
                                }
                            })
                            json=JSON.stringify(json)
                        }
                    }
                    if ($(this).find('span').attr("class")=="input-group-addon param"){
                        param=$(this).find('input').val()
                        if (param!="None"){
                            param=parseParams(JSON.parse(param))
                            param="?"+param
                        }
                    }
                    if ($(this).find('span').attr("class")=="input-group-addon except"){
                        except=$(this).find('input').val()
                        except=JSON.parse(except)
                    }
                })
                $(this).parent().nextAll().each(function(){
                    if ($(this).children().attr("class")=="result"){
                        result=$(this).children()
                    }
                    if ($(this).children().attr("class")=="response"){
                        response=$(this).children()
                    }
                })
                if (param!="None"){
                    url=url+param
                }
                $.ajax({
                    url:url,
                    type:method,
                    data:json,
                    contentType:"application/json;charset=utf-8",
                    success:function(data,status){
                        $.each(except,function(key, val){
                            if (except[key]!=data[key]){
                                status="false"
                            }
                        })
                        if (status!="success"){
                            result.css({"color":"red"})
                        }
                        else{
                            result.css({"color":"green"})
                        }
                        result.text(status)
                        response.text(JSON.stringify(data,null,4))
                    }
                })
            })
        })
    </script>
{% endblock %}